<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>JOGO Cloud NES</title>
<style>
  html,body{margin:0;height:100%;background:#000;color:#00ff66;
    font-family:Poppins,sans-serif;overflow:hidden;}
  #game{width:100%;height:100%;}
  #loading{
    position:fixed;inset:0;display:flex;flex-direction:column;
    justify-content:center;align-items:center;
    background:#000;z-index:100;color:#00ff66;
  }
  .circle{
    width:80px;height:80px;border:4px solid rgba(0,255,100,.3);
    border-top:4px solid #00ff66;border-radius:50%;
    animation:spin 1s linear infinite;margin-bottom:15px;
  }
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  #percent{font-size:22px;font-weight:bold;}
  .erro{color:#ff4040;margin-top:8px;font-size:18px;}

  /* ======= Caixa FPS / PING ======= */
  .perf-box {
    position: fixed;
    top: 16px;
    right: 16px;
    z-index: 9999;
    padding: 10px 14px;
    border-radius: 8px;
    border: 3px solid #00ff66;
    background: rgba(0,0,0,0.85);
    display: flex;
    flex-direction: column;
    gap: 6px;
    min-width: 96px;
    text-align: center;
    font-family: Poppins, sans-serif;
  }
  .perf-line, .perf-small {
    font-weight: 700;
    line-height: 1;
    text-shadow: 0 0 6px rgba(0,255,102,0.25);
    transition: color 0.3s;
  }
  .perf-line { font-size: 18px; }
  .perf-small { font-size: 14px; opacity: 0.95; }

  /* Cores */
  .verde { color:#00ff66; }
  .amarelo { color:#ffd000; }
  .vermelho { color:#ff4040; }

  @media (max-width:420px){
    .perf-box{right:10px;top:10px;padding:8px 10px;min-width:78px}
    .perf-line{font-size:16px}
    .perf-small{font-size:12px}
  }
</style>
</head>
<body>
  <div id="loading">
    <div class="circle"></div>
    <div id="percent">0%</div>
    <div id="status">Preparando...</div>
    <div id="erro" class="erro"></div>
  </div>

  <div id="game"></div>

  <!-- Caixa de FPS / PING -->
  <div id="perfBox" class="perf-box" aria-live="polite" title="Performance">
    <div id="fpsVal" class="perf-line verde">-- FPS</div>
    <div id="pingVal" class="perf-small verde">-- PING</div>
  </div>

<script>
const params = new URLSearchParams(window.location.search);
let gameUrl = params.get("url");
const percent = document.getElementById("percent");
const statusTxt = document.getElementById("status");
const erroTxt = document.getElementById("erro");
let nomeArquivo = "";

if (!gameUrl) {
  statusTxt.innerHTML = "⚠️ Nenhum link de jogo encontrado.";
} else {
  iniciarSistema(gameUrl);
}

async function iniciarSistema(url) {
  try {
    nomeArquivo = url.split("/").pop();
    const dirHandle = await getGameDirectory();
    const arquivoExiste = await verificarArquivo(dirHandle, nomeArquivo);

    if (arquivoExiste) {
      statusTxt.textContent = "Jogo encontrado localmente. Iniciando...";
      const fileHandle = await dirHandle.getFileHandle(nomeArquivo);
      const file = await fileHandle.getFile();
      const blobUrl = URL.createObjectURL(file);
      iniciarEmulador(blobUrl);
    } else {
      await tentarBaixar(url, dirHandle);
    }
  } catch (e) {
    erroTxt.textContent = "❌ Erro: " + e.message;
  }
}

async function getGameDirectory() {
  const root = await navigator.storage.getDirectory();
  const assetsDir = await root.getDirectoryHandle("assets", { create: true });
  const gamesDir = await assetsDir.getDirectoryHandle("games", { create: true });
  return gamesDir;
}

async function verificarArquivo(dirHandle, nome) {
  try {
    await dirHandle.getFileHandle(nome);
    return true;
  } catch {
    return false;
  }
}

async function tentarBaixar(url, dirHandle) {
  try {
    await baixarESalvar(url, dirHandle);
  } catch (e) {
    console.warn("Download direto falhou, tentando via proxy...");
    const proxyUrl = `https://corsproxy.io/?url=${encodeURIComponent(url)}`;
    try {
      await baixarESalvar(proxyUrl, dirHandle);
    } catch (e2) {
      erroTxt.textContent = "❌ Falha total ao baixar: " + e2.message;
    }
  }
}

async function baixarESalvar(url, dirHandle) {
  statusTxt.textContent = "Baixando jogo...";
  const resp = await fetch(url);
  if (!resp.ok) throw new Error(`HTTP ${resp.status} - ${resp.statusText}`);

  const total = +resp.headers.get("Content-Length");
  const reader = resp.body.getReader();
  let recebido = 0;
  const chunks = [];

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    chunks.push(value);
    recebido += value.length;
    if (total) {
      percent.textContent = Math.floor((recebido / total) * 100) + "%";
    }
  }

  const blob = new Blob(chunks);
  const fileHandle = await dirHandle.getFileHandle(nomeArquivo, { create: true });
  const writable = await fileHandle.createWritable();
  await writable.write(blob);
  await writable.close();

  statusTxt.textContent = "Download concluído. Iniciando...";
  iniciarEmulador(URL.createObjectURL(blob));
}

function iniciarEmulador(blobUrl) {
  document.getElementById("loading").remove();

  window.EJS_player = "#game";
  window.EJS_core = "nes";
  window.EJS_biosUrl = "assets/bios/bios.bin";
  window.EJS_gameUrl = blobUrl;
  window.EJS_pathtodata = "data/";
  window.EJS_color = "#00ff66";
  window.EJS_startOnLoaded = true;

  const s = document.createElement("script");
  s.src = "data/loader.js";
  document.body.appendChild(s);

  startPerfMeters();
}

/* ======= Medidores FPS e PING ======= */
function startPerfMeters(){
  let frames = 0;
  let lastTime = performance.now();
  let fps = 0;
  const fpsEl = document.getElementById('fpsVal');
  const pingEl = document.getElementById('pingVal');
  let pingAtual = 0;

  function atualizarCor(valor, elemento){
    elemento.classList.remove('verde','amarelo','vermelho');
    if (valor >= 50 && valor <= 100) elemento.classList.add('verde');
    else if (valor >= 30 && valor <= 40) elemento.classList.add('amarelo');
    else if (valor >= 10 && valor <= 20) elemento.classList.add('vermelho');
  }

  function rafTick(t){
    frames++;
    const delta = t - lastTime;
    if (delta >= 500) {
      fps = Math.round((frames / delta) * 1000);
      fpsEl.textContent = `${fps} FPS`;
      atualizarCor(fps, fpsEl);
      frames = 0;
      lastTime = t;
    }
    window.requestAnimationFrame(rafTick);
  }
  window.requestAnimationFrame(rafTick);

  async function measurePing(){
    try {
      const url = window.location.href.split('#')[0];
      const start = performance.now();
      let res;
      try {
        res = await fetch(url, { method: 'HEAD', cache: 'no-store' });
      } catch (e) {
        res = await fetch(url, { method: 'GET', cache: 'no-store' });
      }
      const end = performance.now();
      pingAtual = Math.max(0, Math.round(end - start));
      pingEl.textContent = `${pingAtual} ms PING`;
      atualizarCor(pingAtual, pingEl);
    } catch {
      pingEl.textContent = `-- PING`;
    }
  }

  measurePing();
  const pingInterval = setInterval(measurePing, 5000);
  return () => clearInterval(pingInterval);
}
</script>
</body>
</html>
